function displayError(a){$("#activity-indicator-container").remove(),$("#message-text").html(a),$("#error-message").show()}function loadResult(a){$("#activity-indicator-container").remove(),$("#error-message").remove(),$("#full").html(a),$("#plan-container").length>0&&activateOrdering(),$("#gw-redirector").length>0&&redirect()}function redirect(){location.href=$("#activity-indicator-container").data("redirect")}function getSelectionLimits(){var a=$("#plan-container");return{book:a.data("booklimit"),buy:a.data("buylimit")}}function checkIfUserReachedSeatsLimits(a){var b=$("#fade_content div.selected").length,c=getSelectionLimits(),d=$("#action-type").val();return void 0!=a&&b++,"book"==d&&c.book<b?(alert("Нельзя выбрать более "+c.book+" мест для брони.\nПожалуйста, отмените лишние места на схеме зала."),!0):"presale"==d&&c.buy<b?(alert("Нельзя выбрать более "+c.buy+" мест для покупки.\nПожалуйста, отмените лишние места на схеме зала."),!0):!1}function activateOrdering(){$("<div/>",{id:"ordering_overlay","class":"overlay"}).css({height:$(document).height(),width:$(document).width()}).appendTo("body"),$("#order-form").appendTo("body"),$(document).on("click","#fade_content div.plan-canvas > div.status-1",function(){if(!checkIfUserReachedSeatsLimits(!0)){$(this).hasClass("selected")?$(this).removeClass("selected"):$(this).addClass("selected");var a=""==$("#total-price").html()?0:parseInt($("#total-price").html()),b=$(this).data("type"),c=$("div.legend-entry > span.type-"+b),d=$(this).hasClass("selected")?a+parseInt(c.data("price")):a-parseInt(c.data("price"));$("#total-price").html(d>0?d:"0"),$("#total-price2").html("Итого: "+$("#total-price").html()+'<span class="rouble">Р</span>');var e=$(".selected"),f=$("#places-list");f.html(""),e.length>0?e.each(function(){place=$(this).data("place").split("-"),$("<div>").addClass("place-entry").append($("<span>").addClass("nums").html("Ряд "+place[0]+", место: "+place[1])).append($("<span>").addClass("price").html($("div.legend-entry > span.type-"+$(this).data("type")).data("price")+'<span class="rouble">Р</span>')).appendTo(f)}):f.html("")}}),$(document).on("click","#fade_content #order-continue",function(a){if(a.preventDefault(),checkIfUserReachedSeatsLimits())return!1;if(0==$("div.selected").length)return alert("Пожалуйста, выберите места"),!1;$("body").css("overflow","hidden");var b=$("#order-form"),c=$("#wrapper"),d=parseInt(c.offset().left+c.width()/2-b.width()/2),e=parseInt($(window).scrollTop()+b.height()/2);b.removeClass("hidden").css({left:d+"px",top:e+"px",border:"0"});var f=$("#action-type").val();return"presale"==f?changeTypeToSale():changeTypeToBook(),!1}),$(d).on("click","#finalize-order",function(a){a.preventDefault();var b=$("#plan-container").data("booklimited"),c=$("#action-type").val();return"book"==c&&"Y"==b?($("#form-error").html("Лимит броней на сеанс исчерпан. Доступна покупка."),!1):checkIfUserReachedSeatsLimits()?!1:void makeOrder(c)}),$("#action-type").change(function(){"presale"==$("#action-type").val()?changeTypeToSale():changeTypeToBook()})}function changeTypeToSale(){$("#surname-field").hide(),$("#finalize-order").html("Оплатить банковской картой").val("Оплатить банковской картой"),$("#phone-field").show(),$("#card-field").show(),checkIfUserReachedSeatsLimits()}function changeTypeToBook(){$("#surname-field").show(),$("#finalize-order").html("Забронировать билеты").val("Забронировать билеты"),$("#phone-field").hide(),$("#card-field").hide(),checkIfUserReachedSeatsLimits()}function closeOrderForm(){return $("body").css("overflow","auto"),$("#order-form").addClass("hidden"),!1}function makeOrder(a){var b=$("div.selected"),c=$("#plan-container").data("seq"),d=$("#plan-container").data("level"),e="";if(hideValidationError(),b.each(function(){var a=$(this).data("place").split("-"),b=$(this).data("dcode");e=e+"[r="+a[0]+";p="+a[1]+";f=0;l="+d,e+=void 0!==b&&"0"!=b?";d="+b+"]":"]"}),!$("#iagree").prop("checked"))return showValidationError("Пожалуйста, примите условия договора-оферты"),!1;if(""==$("#email").val())return showValidationError("Пожалуйста, укажите адрес email"),!1;if("book"==a&&""==$("#surname").val())return showValidationError("Пожалуйста, укажите фамилию"),!1;var f=$("#ordering-form").serializeAll(),g="";for(var h in f)g+=0==h?"?"+f[h].name+"="+f[h].value:"&"+f[h].name+"="+f[h].value;return g+="&seqID="+c+"&places="+e,chrome.tabs.create({url:"http://kinomax.ru/order/"+a+"/"+g},function(a){console.log(a)}),!1}function showValidationError(a){$("#form-error").html(a).toggle()}function hideValidationError(){$("#form-error").toggle()}var d=document,D=$(d),w=window,W=$(w),T=chrome.tabs,fade=d.querySelector("#fade_content"),user=!1,Kino=function(){this.config={dateField:$("#date"),form:$("#timetableForm"),host:"http://kinomax.ru",kinopoisk:"http://www.kinopoisk.ru/search/chrometoolbar.php?v=1&query=",timetableBlock:$("#timetable"),timetableUrl:"http://kinomax.ru/index2.php",bronLink:"/order/hallplan/",host:"http://kinomax.ru",orderLink:"/schedule/booking.php?",checkUserUrl:"/index2.php?r=lk/index",authUrl:"/index2.php?r=lk/login",userBlock:$("#authBlock"),places:[],checkString:"Данный функционал доступен только зарегистрированным пользователям.",orderPlace:null,placeDesc:null,sessionID:null,orderLimit:2,orderLevel:null,anonimus:"true",orderType:"book",userSess:null,videoCount:3};var a=this.config;this.init=function(){woolYoutube.init({"max-results":a.videoCount,category:"trailer"}),b.ajax(function(c){var d=$(c).find("#yw0");-1===c.indexOf(a.checkString)&&void 0===d[0]&&(a.orderLimit=20,a.anonimus="false",user=!0,a.userBlock.html("<b>Вы авторизованы на сайте киномакс!</b> У вас есть возможность бронировать до 20 - ти билетов.")),b.ui(),b.addEvents(),b.actions.setCity()},{url:a.host+a.checkUserUrl,cont:"#content"})},this.ui=function(){$("#datepicker").datepicker({showWeek:!0,firstDay:1,beforeShowDay:function(a){var c=a.getMonth()+1;return a.getFullYear()>b.getDate("year")?[!0,,""]:c<b.getDate("month")?[!1,,"Сеасы уже прошли(-:"]:c>b.getDate("month")?[!0,,""]:a.getDate()<b.getDate()?[!1,,"Сеасы уже прошли(-:"]:[!0,,""]},onSelect:function(c){a.dateField.val(b.dateReplaced(c)),b.actions.getTimetable()}});var c=new Date;a.dateField.val(c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate())},this.addEvents=function(){D.on("change","#city",b.actions.getTimetable),D.on("click","#timetable a:not(.time, .kinopoisk, .youtube), #logo",b.actions.clickTableLink),D.on("mouseover",".time",b.actions.over),D.on("mouseleave",".time, .kinopoisk",b.actions.out),D.on("click",".time",b.actions.openFade),D.on("transitionend","#fade, .close",b.actions.animEnd),D.on("click",".close",b.actions.closeFade),D.on("click","#fade_content .get-order",b.actions.getOrder),D.on("click","#getUser",b.actions.auth),D.on("click",".kinopoisk",b.actions.kinopoisk),D.on("click",".youtube",b.actions.viewTrailer),D.on("click","#searchButton",b.actions.getVideoFromString)},this.actions={getVideoFromString:function(){var a=($(this),fade.querySelector("input[name=searchVideo]").value);return a&&woolYoutube.search(a,function(c){b.putVideoInPage(c,a)}),!1},viewTrailer:function(){var a,c=this,d=$(c).data("film"),e={};return $("#fade").addClass("visible"),chrome.storage.local.get("videos",function(c){c.videos&&void 0!==c.videos?(a=JSON.parse(c.videos),a[d]?b.putVideoInPage(a[d]):woolYoutube.search(d,function(c){$("#fade").addClass("visible"),b.putVideoInPage(c),c[0]&&(a[d]=c,chrome.storage.local.set({videos:JSON.stringify(a)}))})):woolYoutube.search(d,function(a){$("#fade").addClass("visible"),b.putVideoInPage(a),a[0]&&(e[d]=a,chrome.storage.local.set({videos:JSON.stringify(e)}))})}),!1},getTimetable:function(){var c=event||window.event;if("change"===c.type){var d=this.value;chrome.storage.local.set({city:d})}var e=a.form.serializeArray();a.timetableBlock.removeClass("visible"),b.ajax(function(a){b.parceTimeTable(a)},{url:e,cont:a.timetableBlock})},clickTableLink:function(){var b=$(this),c=b.attr("href");return b.hasClass("time")||T.create({url:a.host+c}),!1},over:function(){var b=$(this),c=b.data("content").split(","),d=event||window.event,e=d.pageX,f=d.pageY,g="";g='<div class="pop" style="position: absolute; top: '+(f-30)+"px; left: "+(e+30)+'px;"><b>'+c[1]+"</b>"+c[0]+"</div>",a.timetableBlock.append(g)},out:function(){a.timetableBlock.find(".pop").remove()},openFade:function(){var c,d=$(this);return $("#fade").addClass("visible"),a.sessionID=b.getIdentify(d.attr("href")),c=a.host+a.bronLink+a.sessionID,b.ajax(function(a){b.parceBron(a)},{url:c,cont:"#fade_content",delay:1800}),!1},closeFade:function(){var b=$(this);return b.addClass("hidden"),$("#fade").removeClass("visible"),fade.innerHTML="",a.places=[],!1},animEnd:function(){$(this).find(".close").removeClass("hidden")},auth:function(){var c=($(this),a.userBlock),d=c.serializeArray(),e=a.host+a.authUrl;return b.ajax(function(b){var c=$(b).find("#yw0");-1===b.indexOf(a.checkString)&&void 0===c[0]?($("#authBlock").html("Вы успешно авторизованы на сайте киномакс. Приятного просмотра:-)"),a.orderLimit=20,a.anonimus="false",user=!0,chrome.cookies.set({url:a.host,name:"extUser",value:"true"})):($("#authBlock #messages").html("Вы ввели неправильные данные, или произошла трагическая случайность. Попробуйте еще раз."),a.orderLimit=2,a.anonimus="true",user=!1,chrome.cookies.remove({url:a.host,name:"extUser"}))},{url:e,cont:"#authBlock",data:d}),!1},setCity:function(){chrome.storage.local.get("city",function(c){for(var d=$("#city option"),e=d.length;e--;){var f=$(d[e]).val();if(c.city===f){$(d[e]).attr("selected","selected");break}}if(c.city&&void 0!==c.city){var g=a.form.serializeArray();a.timetableBlock.removeClass("visible"),b.ajax(function(a){b.parceTimeTable(a)},{url:g,cont:a.timetableBlock})}})},kinopoisk:function(){var c=$(this),d=c.data("film"),e=a.kinopoisk+encodeURIComponent(d),f=event||window.event;return chrome.storage.local.get("kino",function(a){if(a.kino&&void 0!==a.kino){var c=JSON.parse(a.kino);if(void 0!==c[d]){var g=c[d].time+86400,h=Math.round((new Date).getTime()/1e3);b.showWindow({text:c[d].rating,x:f.pageX,y:f.pageY}),h>g&&(delete c[d],chrome.storage.local.set({kino:JSON.stringify(c)}))}else b.ajax(function(a){c[d]={rating:a.rating,time:Math.round((new Date).getTime()/1e3)},chrome.storage.local.set({kino:JSON.stringify(c)}),b.showWindow({text:c[d].rating,x:f.pageX,y:f.pageY})},{url:e,reqType:"get",type:"json"})}else b.ajax(function(a){if(void 0!==a.type){var c={};c[d]={rating:a.rating,time:Math.round((new Date).getTime()/1e3)},chrome.storage.local.set({kino:JSON.stringify(c)}),b.showWindow({text:c[d].rating,x:f.pageX,y:f.pageY})}},{url:e,reqType:"get",type:"json"})}),!1}},this.parceTimeTable=function(b){var c=$(b).find(".user-sessions-container");c.find("span").removeAttr("onmouseout").removeAttr("onmouseover");for(var d=c.find("a"),e=d.length;e--;){var f=$(d[e]),g=f.attr("onmouseover");if(void 0!==g){var h=g.substr(4,g.length-2).replace("')","").replace("', TITLE","").replace("'","").replace(" '","").replace("</a>","");f.removeAttr("onmouseover").data("content",h).addClass("time")}f.removeAttr("onmouseout")}for(var i=$(c).find("tr"),j=i.length,k=0;j>k;k++){var f=$(i[k]).find("td").first(),l=f.children(),m=$(l).is("span");void 0===l[0]||m||l.after('<div class="dop-inform"><a href="#" title="Узнать рейтинг фильма на кинопоиске" class="kinopoisk" data-film="'+l.text()+'"></a><a href="#" title="Посмотреть трейлер к фильму" data-film="'+l.text()+'" class="youtube"></a></div>')}a.timetableBlock.html(void 0===c[0]?'<b class="noresults">Сеансов в данном городе на это число не обнаруженно!</b>':c),a.timetableBlock.addClass("visible")},this.parceBron=function(c){{var d="<div>"+c+"</div>",e=$(d).find("#activity-indicator-container");$(d).find("style")}if(void 0!==e[0]){var f=e.data("seq"),g=a.host+"/order/checkstatus?screen=700&seqID="+f;b.ajax(function(a){var b=$(a.html);b.find("img").remove(),b.find(".close-link").find("a")[0].removeAttribute("onclick"),b.find("#charity")[0].removeAttribute("onchange"),$("#fade_content").append(b)},{url:g,cont:"#fade_content",delay:1800,type:"json"})}else $("#fade_content").html("<h2>Ошибка выполнения запроса</h2>Извините, произошла ошибка при подключении к кинотеатру, возможно кинотеатр недоступен в данный момент, попробуйте еще раз чуть позже. Спасибо.")};var b=this};Kino.prototype.putVideoInPage=function(a,b){var c=a.length,d="";void 0===b&&(b=""),c>0?setTimeout(function(){for(var e=0;c>e;e++)d+='<div class="trailer"><iframe width="640" height="360" src="http://www.youtube.com/embed/'+a[e].id+'" frameborder="0" allowfullscreen></iframe></div>';fade.innerHTML='<div id="searchForm"><label><b>Найти другое видео:</b><input type="text" name="searchVideo" value="'+b+'" /></label><button id="searchButton">Найти</button></div><div id="videoResult">'+d+"</div>"},1200):fade.innerHTML='<div id="searchForm"><label><b>Найти другое видео:</b><input type="text" name="searchVideo" value="'+b+'" /></label><button id="searchButton">Найти</button></div><div id="videoResult"><p>Видео по этому запросу найдено не было!</p></div>'},Kino.prototype.showWindow=function(a){var b='<div class="pop" style="position: absolute; top: '+(a.y-20)+"px; left: "+(a.x-50)+'px;">'+a.text+"</div>";this.config.timetableBlock.append(b)},Kino.prototype.ajax=function(a,b){return void 0===b?!1:("object"==typeof b.url&&(b.url=this.parceObjectToUrl(this.config.timetableUrl,b.url)),void 0===b.reqType&&(b.reqType="post"),void $.ajax({type:b.reqType,dataType:b.type||"html",processData:!0,url:b.url||this.config.timetableUrl,data:b.data,cache:!1,beforeSend:function(){$(b.cont).append('<div class="loading">Идет подключение к кинотеатру...</div>')},success:function(c){void 0!==b.delay?setTimeout(function(){a(c),$(b.cont).find(".loading").remove()},b.delay):(a(c),$(b.cont).find(".loading").remove())}}))},Kino.prototype.updateOrder=function(a){var b=this.config.orderPlace,c=this.config.placeDesc,d=this.config.credentials,e=0,f="<b>Вами выбраны следующие места:</b>";for(i in a){var g=c.find("."+a[i].type).next().find(".price-sum");e+=parseInt(g.attr("id")),f+='<div class="orderPlace">'+a[i].place[1]+" ряд, "+a[i].place[2]+" место."+g.text()+"</div>"}e/=100,f+="<b>Сумма: "+e+" руб.</b>",0===e?(b.css("display","none"),d.css("display","none"),b.html("")):(b.css("display","block"),d.css("display","block"),b.html(f))},Kino.prototype.updateArray=function(a,b){var c=[];for(i in a)i!==b&&(c[i]=a[i]);return c},Kino.prototype.getIdentify=function(a){var b=a.split("/"),c=b[3].split(".");return c[0]},Kino.prototype.getDate=function(a){var b=new Date;switch(a){case"day":return b.getDate();case"month":return b.getMonth()+1;case"year":return b.getFullYear();default:return b.getDate()}},Kino.prototype.dateReplaced=function(a){for(var b=a.split("."),c=b.length,d=[],e=0;c--;)d[e]=b[c],e++;return d.join("-")},Kino.prototype.parceObjectToUrl=function(a,b){for(var c="?",d=b.length,e=0;d>e;e++)c+=b[e].name+"="+b[e].value+"&";return a+c.substr(0,c.length-1)},w.onload=function(){var a=new Kino;a.init()},$(document).ready(function(){activateOrdering()}),$(d).on("click",".close-link a",function(){return closeOrderForm(),!1}),function(a){a.fn.serializeAll=function(){var b=a(this).serializeArray();return a(":disabled[name]",this).each(function(){b.push({name:this.name,value:a(this).val()})}),b}}(jQuery),jQuery(function(a){a.datepicker.regional.ru={closeText:"Закрыть",prevText:"&#x3c;Пред",nextText:"След&#x3e;",currentText:"Сегодня",monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],monthNamesShort:["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"],dayNames:["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"],dayNamesShort:["вск","пнд","втр","срд","чтв","птн","сбт"],dayNamesMin:["Вс","Пн","Вт","Ср","Чт","Пт","Сб"],weekHeader:"Не",dateFormat:"dd.mm.yy",firstDay:1,isRTL:!1,showMonthAfterYear:!1,yearSuffix:""},a.datepicker.setDefaults(a.datepicker.regional.ru)});var woolYoutube=function(){var a=document,b=window,c=($(a),$(b),{}),d=[],e="http://gdata.youtube.com/feeds/api/videos?alt=json",f=function(){},g=f.prototype,h=function(a,b){var c={},d=a.id.$t.split("/"),e=d.length,f=a.title.$t;return-1!==f.indexOf(b)?c={id:d[e-1],title:a.title.$t,thumbs:a.media$group.media$thumbnail,video:"http://www.youtube.com/watch?v="+d[e-1],duration:a.media$group.yt$duration.seconds}:!1};return g.init=function(a){c={key:null,"max-results":5,"start-index":0,caption:null,category:null,lr:null,orderby:null},$.extend(c,a)},g.search=function(a,b){var c="",f="";if(d=[],!a||void 0===a)throw"Запрос пуст!";c=decodeURI(a),f=e+this._buildingUrl(c),this._ajax({url:f},function(c){if(c.feed)for(var e=c.feed,f=e.entry,g=f.length;g--;){var i=f[g],j=h(i,a);j&&d.push(j)}else{var j=h(e.entry,a);j&&d.push(j)}b(d)})},g._buildingUrl=function(a){var b="&q="+a;for(var d in c)c[d]&&(b+="&"+d+"="+c[d]);return console.log(b),b},g._ajax=function(a,b){if(void 0===a)throw"Не заданны опции для запроса!";$.ajax({type:a.type||"get",dataType:"json",processData:!0,url:a.url,data:a.data,cache:!1,beforeSend:function(){},success:function(a){b(a)}})},new f}(jQuery);